<html>

<head>
    <link rel="stylesheet" type="text/css" rel="noopener" target="_blank" href="style.css">
    <script src="img.js"></script>
    <script src="db.js"></script>
    <script>
        let DbList;

        function lookInDb(key) {
            var ret = [];
            if ('High' in db.elements[key]) {
                ret.push(...Object.keys(db.elements[key].High.elements));
            }
            if ('Low' in db.elements[key]) {
                ret.push(...Object.keys(db.elements[key].Low.elements));
            }
            for (const [k, v] of Object.entries(db.elements)) {
                if ('High' in v && key in v.High.elements) {
                    ret.push(k);
                }
                if ('Low' in v && key in v.Low.elements) {
                    ret.push(k);
                }
            }
            console.log([...new Set(ret)]);
            while (DbList.firstChild) {
                DbList.firstChild.remove();
            }
            for (const e of [...new Set(ret)]) {
                elem = document.getElementById(e).cloneNode(true);
                elem.removeAttribute('id');
                DbList.insertAdjacentElement("afterbegin", elem);
            }
        }

        window.addEventListener('load', function () {
            let elementsList = document.createElement('div');
            elementsList.id = "ElementsList";
            DbList = document.createElement('div');
            elementsList.style.width = '132px';
            elementsList.style.height = '500px';
            elementsList.style.overflow = 'auto';
            DbList.style.width = '132px';
            DbList.style.height = '500px';
            DbList.style.overflow = 'auto';
            DbList.style.position = 'absolute';
            DbList.style.left = window.innerWidth - 140 + 'px';
            DbList.style.top = 0;
            for (const [key, value] of Object.entries(db.elements)) {
                let figure = document.createElement("figure");
                figure.className = "elements";
                figure.id = key;
                figure.setAttribute("element", key);
                figure.onmousedown = function (event) {
                    let c = figure.cloneNode(true);
                    c.removeAttribute('id');
                    c.style.position = 'absolute';
                    lookInDb(c.getAttribute("element"));
                    document.body.append(c);
                    offsetX = event.pageX - figure.getBoundingClientRect().left;
                    offsetY = event.pageY - figure.getBoundingClientRect().top;
                    console.log(offsetX, offsetY);
                    function moveAt(pageX, pageY) {
                        c.style.left = ((pageX - offsetX) / 20).toFixed() * 20 + 'px';
                        c.style.top = ((pageY - offsetY) / 20).toFixed() * 20 + 'px';
                    }
                    moveAt(event.pageX, event.pageY);
                    function onMouseMove(event) {
                        moveAt(event.pageX, event.pageY);
                    }
                    document.addEventListener('mousemove', onMouseMove);
                    document.onmouseup = function (event) {
                        document.removeEventListener('mousemove', onMouseMove);
                        document.onmouseup = null;
                        var omd = function (event) {
                            lookInDb(c.getAttribute("element"));
                            c.onmousedown = null;
                            offsetX = event.pageX - c.getBoundingClientRect().left;
                            offsetY = event.pageY - c.getBoundingClientRect().top;
                            console.log(offsetX, offsetY);
                            function moveAt2(pageX, pageY) {
                                c.style.left = ((pageX - offsetX) / 20).toFixed() * 20 + 'px';
                                c.style.top = ((pageY - offsetY) / 20).toFixed() * 20 + 'px';
                                console.log((pageX - offsetX));
                            }
                            moveAt2(event.pageX, event.pageY);
                            omm = function onMouseMove2(event) {
                                moveAt2(event.pageX, event.pageY);
                            }
                            document.addEventListener('mousemove', omm);
                            document.onmouseup = function (event) {
                                document.removeEventListener('mousemove', omm);
                                document.onmouseup = null;
                                c.onmousedown = omd;
                                console.log((event.pageX - offsetX));
                                if (((event.pageX - offsetX) / 20).toFixed() * 20 < 140) {
                                    c.remove();
                                }
                            };
                        }
                        c.onmousedown = omd;
                        if (((event.pageX - offsetX) / 20).toFixed() * 20 < 140) {
                            c.remove();
                        }
                    };
                }
                let image = document.createElement('img');
                console.log(img.elements);
                image.setAttribute('src', 'images/elements/' + img.elements[key] + '.png');
                image.draggable = false;
                let caption = document.createElement("figcaption");
                caption.insertAdjacentHTML('afterbegin', key);
                figure.appendChild(image);
                figure.appendChild(caption);
                console.log(figure);
                elementsList.appendChild(figure);
            }
            document.body.appendChild(elementsList);
            document.body.appendChild(DbList);

        });
    </script>
</head>

<body></body>

</html>